From 771d434b562af2eaeae067dcff7e38839915ea5f Mon Sep 17 00:00:00 2001
From: DokFaust <rodia@autistici.org>
Date: Mon, 28 May 2018 00:46:14 +0200
Subject: [PATCH 4/5] Definition of MCTJIT replacement changed

---
 0002-Changed-notifyFinalized-call.patch       | 25 +++++++++++++++++++
 lib/ExecutionEngine/Orc/OrcMCJITReplacement.h |  2 +-
 2 files changed, 26 insertions(+), 1 deletion(-)
 create mode 100644 0002-Changed-notifyFinalized-call.patch

diff --git a/0002-Changed-notifyFinalized-call.patch b/0002-Changed-notifyFinalized-call.patch
new file mode 100644
index 00000000000..3a38cc55a1e
--- /dev/null
+++ b/0002-Changed-notifyFinalized-call.patch
@@ -0,0 +1,25 @@
+From 55734a0ba472ceedb6cfbad7a2b2d472529bc31a Mon Sep 17 00:00:00 2001
+From: DokFaust <rodia@autistici.org>
+Date: Sun, 27 May 2018 22:45:36 +0200
+Subject: [PATCH 2/3] Changed notifyFinalized call
+
+---
+ include/llvm/ExecutionEngine/Orc/RTDyldObjectLinkingLayer.h | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/include/llvm/ExecutionEngine/Orc/RTDyldObjectLinkingLayer.h b/include/llvm/ExecutionEngine/Orc/RTDyldObjectLinkingLayer.h
+index a783fda3761..2a08a05f40d 100644
+--- a/include/llvm/ExecutionEngine/Orc/RTDyldObjectLinkingLayer.h
++++ b/include/llvm/ExecutionEngine/Orc/RTDyldObjectLinkingLayer.h
+@@ -279,7 +279,7 @@ public:
+       RTDyld.finalizeWithMemoryManagerLocking();
+ 
+       if (this->NotifyFinalized)
+-        this->NotifyFinalized(H);
++        this->NotifyFinalized(H, ObjToLoad, *Info);
+     };
+ 
+     auto LO =
+-- 
+2.17.0
+
diff --git a/lib/ExecutionEngine/Orc/OrcMCJITReplacement.h b/lib/ExecutionEngine/Orc/OrcMCJITReplacement.h
index 1dc8d4ac7bc..e70d2eabd6e 100644
--- a/lib/ExecutionEngine/Orc/OrcMCJITReplacement.h
+++ b/lib/ExecutionEngine/Orc/OrcMCJITReplacement.h
@@ -176,7 +176,7 @@ public:
                                                         std::move(MemMgr))),
         Resolver(std::make_shared<LinkingResolver>(*this)),
         ClientResolver(std::move(ClientResolver)), NotifyObjectLoaded(*this),
-        NotifyFinalized(*this),
+        NotifyFinalized(*this), NotifyFreed(*this),
         ObjectLayer([this]() { return this->MemMgr; }, NotifyObjectLoaded,
                     NotifyFinalized),
         CompileLayer(ObjectLayer, SimpleCompiler(*this->TM)),
-- 
2.17.0

